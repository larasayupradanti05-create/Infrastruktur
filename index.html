<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Jalan UPNVJT</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
body{font-family:'Poppins',sans-serif;background:#f8f9fa;}
.sidebar{height:100vh;width:250px;background:#0d6efd;color:white;position:fixed;padding:1rem;display:flex;flex-direction:column;}
.sidebar h4{text-align:center;margin-bottom:2rem;font-weight:700;}
.sidebar a{color:#dbe4ff;text-decoration:none;padding:10px 15px;margin-bottom:5px;border-radius:8px;display:block;transition:0.2s;}
.sidebar a:hover,.sidebar a.active{background:#ffffff22;color:#fff;}
.main-content{margin-left:260px;padding:2rem;}
.card{border-radius:1rem;box-shadow:0 4px 15px rgba(0,0,0,0.05);margin-bottom:2rem;padding:1rem;transition:transform 0.2s;}
.card:hover{transform:scale(1.03);}
.icon{width:50px;height:50px;display:flex;align-items:center;justify-content:center;border-radius:50%;font-size:1.5rem;}
.kpi-row .card{display:flex;align-items:center;}
.kpi-row .flex-grow-1{margin-left:1rem;}
</style>
</head>
<body>

<div class="sidebar">
<h4><i class="bi bi-geo-alt-fill"></i> Jalan UPNVJT</h4>
<a href="#" class="active">Dashboard</a>
<a href="data-responden.html">Data Responden</a>
<a href="analisis 1.html">Analisis</a>
<a href="ringkasan.html">Ringkasan</a>
<a href="interaktif.html">Interaktif</a>
<a href="#"><i class="bi bi-info-circle me-2"></i> Tentang</a>
</div>

<div class="main-content">
<h2 class="fw-bold mb-4 text-primary">Dashboard Survei Jalan UPNVJT</h2>

<!-- Upload CSV -->
<div class="text-end mb-4">
<input type="file" id="csvFile" accept=".csv" hidden>
<button class="btn btn-primary" onclick="document.getElementById('csvFile').click()">
<i class="bi bi-upload me-2"></i>Upload CSV
</button>
<button class="btn btn-danger ms-2" onclick="resetData()">Reset Data</button>
</div>

<!-- KPI Cards -->
<div class="row g-4 kpi-row mb-4">
  <div class="col-md-4">
    <div class="card p-3 d-flex align-items-center">
      <div class="icon bg-primary text-white"><i class="bi bi-people"></i></div>
      <div class="flex-grow-1 ms-3">
        <h6>Total Responden</h6>
        <h3 id="totalResponden">0</h3>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card p-3 d-flex align-items-center">
      <div class="icon bg-success text-white"><i class="bi bi-road"></i></div>
      <div class="flex-grow-1 ms-3">
        <h6>Kondisi Jalan Baik (Skor>3)</h6>
        <h3 id="jalanBaik">0%</h3>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card p-3 d-flex align-items-center">
      <div class="icon bg-warning text-white"><i class="bi bi-emoji-smile"></i></div>
      <div class="flex-grow-1 ms-3">
        <h6>Rata-rata Kepuasan</h6>
        <h3 id="rataKepuasan">0.0</h3>
      </div>
    </div>
  </div>
</div>

<!-- Filter Range Skor -->
<div class="row mb-4">
  <div class="col-md-6">
    <label for="rangeMin" class="form-label">Skor Minimal</label>
    <input type="number" id="rangeMin" class="form-control" value="0" min="0" max="5">
  </div>
  <div class="col-md-6">
    <label for="rangeMax" class="form-label">Skor Maksimal</label>
    <input type="number" id="rangeMax" class="form-control" value="5" min="0" max="5">
  </div>
  <div class="col-md-12 mt-2">
    <button class="btn btn-info" onclick="applyFilter()">Terapkan Filter Skor</button>
  </div>
</div>

<!-- Chart Area -->
<div class="row">
  <div class="col-md-6">
    <div class="card">
      <h5>Distribusi Kondisi Jalan</h5>
      <canvas id="chartKondisi"></canvas>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <h5>Distribusi Kepuasan</h5>
      <canvas id="chartKepuasan"></canvas>
    </div>
  </div>
</div>

<p id="infoText" class="text-danger fw-bold mt-3"></p>

</div>

<script>
let surveyData = JSON.parse(localStorage.getItem("surveyData") || "[]");
const csvFile = document.getElementById("csvFile");
let chartKondisi, chartKepuasan;

// KPI & Chart update
function updateDashboard(data){
    localStorage.setItem("surveyData", JSON.stringify(data));
    surveyData = data;

    if(!data || data.length===0){
        document.getElementById("infoText").textContent="⚠️ Data kosong.";
        return;
    }
    document.getElementById("infoText").textContent="";
    document.getElementById("totalResponden").textContent = data.length;

    const kondisi = data.map(r=>parseFloat(r[Object.keys(r)[8]])||0);
    const baik = kondisi.filter(v=>v>3).length;
    const persenBaik = ((baik/data.length)*100).toFixed(1)+"%";
    document.getElementById("jalanBaik").textContent = persenBaik;

    const kepuasan = data.map(r=>parseFloat(r[Object.keys(r)[18]])||0);
    const avgKepuasan = (kepuasan.reduce((a,b)=>a+b,0)/data.length).toFixed(2);
    document.getElementById("rataKepuasan").textContent = avgKepuasan;

    renderCharts(kondisi,kepuasan);
}

function renderCharts(kondisi,kepuasan){
    if(chartKondisi) chartKondisi.destroy();
    if(chartKepuasan) chartKepuasan.destroy();

    // Kondisi Jalan
    const ctx1 = document.getElementById("chartKondisi").getContext("2d");
    const counts1 = {};
    kondisi.forEach(v=>counts1[v]=(counts1[v]||0)+1);
    chartKondisi = new Chart(ctx1,{
        type:"bar",
        data:{labels:Object.keys(counts1),datasets:[{label:"Kondisi Jalan",data:Object.values(counts1),backgroundColor:"rgba(13,110,253,0.7)"}]},
        options:{responsive:true,scales:{y:{beginAtZero:true}}}
    });

    // Kepuasan
    const ctx2 = document.getElementById("chartKepuasan").getContext("2d");
    const counts2 = {};
    kepuasan.forEach(v=>counts2[v]=(counts2[v]||0)+1);
    chartKepuasan = new Chart(ctx2,{
        type:"bar",
        data:{labels:Object.keys(counts2),datasets:[{label:"Kepuasan",data:Object.values(counts2),backgroundColor:"rgba(255,193,7,0.7)"}]},
        options:{responsive:true,scales:{y:{beginAtZero:true}}}
    });
}

// Filter skor
function applyFilter(){
    if(!surveyData.length) return;
    const min = parseFloat(document.getElementById("rangeMin").value)||0;
    const max = parseFloat(document.getElementById("rangeMax").value)||5;

    const filtered = surveyData.filter(r=>{
        const skor = parseFloat(r[Object.keys(r)[8]])||0;
        return skor >= min && skor <= max;
    });
    updateDashboard(filtered);
}

csvFile.addEventListener("change", function(e){
    const file = e.target.files[0];
    Papa.parse(file,{header:true,skipEmptyLines:true,complete:function(results){
        updateDashboard(results.data);
    }});
});

function resetData(){
    if(confirm("Hapus semua data survey?")){
        localStorage.removeItem("surveyData");
        location.reload();
    }
}

// load jika sudah ada
if(surveyData.length>0){
    updateDashboard(surveyData);
}
</script>
</body>
</html>
