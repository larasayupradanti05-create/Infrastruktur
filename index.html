<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Jalan UPNVJT</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
body{font-family:'Poppins',sans-serif;background:#f8f9fa;}
.sidebar{height:100vh;width:250px;background:#0d6efd;color:white;position:fixed;padding:1rem;display:flex;flex-direction:column;}
.sidebar h4{text-align:center;margin-bottom:2rem;font-weight:700;}
.sidebar a{color:#dbe4ff;text-decoration:none;padding:10px 15px;margin-bottom:5px;border-radius:8px;display:block;transition:0.2s;}
.sidebar a:hover,.sidebar a.active{background:#ffffff22;color:#fff;}
.main-content{margin-left:260px;padding:2rem;}
.card{border-radius:1rem;box-shadow:0 4px 15px rgba(0,0,0,0.05);margin-bottom:2rem;padding:1rem;transition:transform 0.2s;}
.card:hover{transform:scale(1.03);}
.icon{width:50px;height:50px;display:flex;align-items:center;justify-content:center;border-radius:50%;font-size:1.5rem;}
.kpi-row .card{display:flex;align-items:center;}
.kpi-row .flex-grow-1{margin-left:1rem;}
</style>
</head>
<body>

<div class="sidebar">
<h4><i class="bi bi-geo-alt-fill"></i> Jalan UPNVJT</h4>
<a href="#" class="active">Dashboard</a>
<a href="data-responden.html">Data Responden</a>
<a href="analisis 1.html">Analisis</a>
<a href="ringkasan.html">Ringkasan</a>
<a href="interaktif.html">Interaktif</a>
<a href="#"><i class="bi bi-info-circle me-2"></i> Tentang</a>
</div>

<div class="main-content">
<h2 class="fw-bold mb-4 text-primary">Dashboard Survei Jalan UPNVJT</h2>

<div class="text-end mb-4">
<input type="file" id="csvFile" accept=".csv" hidden>
<button class="btn btn-primary" onclick="document.getElementById('csvFile').click()"><i class="bi bi-upload me-2"></i>Upload CSV</button>
<button class="btn btn-danger ms-2" onclick="resetData()">Reset Data</button>
</div>

<div class="row g-4 kpi-row mb-4">
<div class="col-md-4">
<div class="card p-3 d-flex align-items-center">
<div class="icon bg-primary text-white"><i class="bi bi-people"></i></div>
<div class="flex-grow-1 ms-3">
<h6>Total Responden</h6>
<h3 id="totalResponden">0</h3>
</div>
</div>
</div>
<div class="col-md-4">
<div class="card p-3 d-flex align-items-center">
<div class="icon bg-success text-white"><i class="bi bi-road"></i></div>
<div class="flex-grow-1 ms-3">
<h6>Kondisi Jalan Baik (Skor>3)</h6>
<h3 id="jalanBaik">0%</h3>
</div>
</div>
</div>
<div class="col-md-4">
<div class="card p-3 d-flex align-items-center">
<div class="icon bg-warning text-white"><i class="bi bi-emoji-smile"></i></div>
<div class="flex-grow-1 ms-3">
<h6>Rata-rata Kepuasan</h6>
<h3 id="rataKepuasan">0.0</h3>
</div>
</div>
</div>
</div>

<div class="row mt-4">
<div class="col-md-6">
<div class="card">
<h5>Analisis Kenyamanan vs Insiden</h5>
<canvas id="chartKenyamanan"></canvas>
</div>
</div>
</div>

<div class="row mt-4">
<div class="col-md-6">
<div class="card">
<h5>Distribusi Kondisi Jalan</h5>
<canvas id="chartKondisi"></canvas>
</div>
</div>
<div class="col-md-6">
<div class="card">
<h5>Distribusi Kepuasan</h5>
<canvas id="chartKepuasan"></canvas>
</div>
</div>
</div>

<p id="infoText" class="text-danger fw-bold mt-3"></p>
</div>

<script>
let surveyData = JSON.parse(localStorage.getItem("surveyData") || "[]");
const csvFile = document.getElementById("csvFile");
let chartKondisi, chartKepuasan, chartKenyamanan;

// Bersihkan dan normalisasi Y
function normalizeY(val){
    if(!val) return "";
    val = val.normalize("NFKD")
             .replace(/[\u2013\u2014\u2015]/g,"-")
             .replace(/[\u00A0]/g," ")
             .replace(/[^\x00-\x7F]/g,"")
             .trim().toLowerCase();
    if(val.includes("1 kali")) return "1 kali";
    if(val.includes("2-3") || val.includes("2 – 3")) return "2-3 kali";
    if(val.includes("lebih dari")) return "lebih dari 3 kali";
    return val;
}

// Render chart kenyamanan vs insiden
function renderKenyamananChart(data){
    if(!data || data.length===0) return;

    const colKenyamanan = "Bagaimana kenyamanan berkendara (motor/mobil) di jalan kampus?";
    const colInsiden = "Berapa kali Anda mengalami kesulitan atau insiden tersebut?";

    const xVals = data.map(r => parseInt(r[colKenyamanan]) || 0);
    const yVals = data.map(r => {
        let val = r[colInsiden] || "";
        val = val.replace(/–|—|–/g, "-").trim().toLowerCase();
        if(val.includes("1 kali")) return "1 kali";
        if(val.includes("2-3") || val.includes("2–3")) return "2-3 kali";
        if(val.includes("lebih dari")) return "lebih dari 3 kali";
        return val;
    });

    const yCategories = ["1 kali","2-3 kali","lebih dari 3 kali"];
    const counts = {};
    yCategories.forEach(y=>counts[y] = [0,0,0,0,0]);

    for(let i=0;i<data.length;i++){
        const x = xVals[i];
        const y = yVals[i];
        if(x>=1 && x<=5 && yCategories.includes(y)){
            counts[y][x-1]++;
        }
    }

    const datasets = yCategories.map((y,i)=>({
        label: y,
        data: counts[y],
        backgroundColor:["rgba(13,110,253,0.7)","rgba(0,200,83,0.7)","rgba(220,53,69,0.7)"][i]
    }));

    const ctx = document.getElementById("chartKenyamanan").getContext("2d");
    if(chartKenyamanan) chartKenyamanan.destroy();
    chartKenyamanan = new Chart(ctx,{
        type:"bar",
        data:{labels:[1,2,3,4,5], datasets: datasets},
        options:{
            responsive:true,
            plugins:{title:{display:true,text:"Kenyamanan vs Insiden"}},
            interaction:{mode:"index",intersect:false},
            scales:{
                x:{stacked:true,title:{display:true,text:"Kenyamanan (1-5)"}},
                y:{stacked:true,title:{display:true,text:"Jumlah Responden"},beginAtZero:true}
            }
        }
    });
}


// Render chart kondisi & kepuasan
function renderCharts(kondisi,kepuasan){
    const ctx1 = document.getElementById("chartKondisi").getContext("2d");
    const counts1 = {};
    kondisi.forEach(v=>counts1[v]=(counts1[v]||0)+1);
    if(chartKondisi) chartKondisi.destroy();
    chartKondisi = new Chart(ctx1,{
        type:"bar",
        data:{labels:Object.keys(counts1), datasets:[{label:"Kondisi Jalan",data:Object.values(counts1),backgroundColor:"rgba(13,110,253,0.7)"}]},
        options:{responsive:true,scales:{y:{beginAtZero:true}}}
    });

    const ctx2 = document.getElementById("chartKepuasan").getContext("2d");
    const counts2 = {};
    kepuasan.forEach(v=>counts2[v]=(counts2[v]||0)+1);
    if(chartKepuasan) chartKepuasan.destroy();
    chartKepuasan = new Chart(ctx2,{
        type:"bar",
        data:{labels:Object.keys(counts2), datasets:[{label:"Kepuasan",data:Object.values(counts2),backgroundColor:"rgba(255,193,7,0.7)"}]},
        options:{responsive:true,scales:{y:{beginAtZero:true}}}
    });
}

// Update dashboard
function updateDashboard(data){
    if(!data || data.length===0){
        document.getElementById("infoText").textContent="⚠️ Data kosong.";
        return;
    }
    document.getElementById("infoText").textContent="";
    surveyData = data;
    localStorage.setItem("surveyData",JSON.stringify(data));

    const headers = Object.keys(data[0]);
    const colKenyamanan = headers.find(h=>h.toLowerCase().includes("kenyamanan"));
    const colInsiden = headers.find(h=>h.toLowerCase().includes("insiden") || h.toLowerCase().includes("kesulitan"));

    if(!colKenyamanan || !colInsiden){
        document.getElementById("infoText").textContent="⚠️ Tidak menemukan kolom kenyamanan atau insiden di CSV.";
        return;
    }

    document.getElementById("totalResponden").textContent = data.length;

    const kondisi = data.map(r=>parseFloat(r[headers[8]])||0);
    const baik = kondisi.filter(v=>v>3).length;
    document.getElementById("jalanBaik").textContent = ((baik/data.length)*100).toFixed(1) + "%";

    const kepuasan = data.map(r=>parseFloat(r[headers[18]])||0);
    const avgKepuasan = (kepuasan.reduce((a,b)=>a+b,0)/kepuasan.length).toFixed(2);
    document.getElementById("rataKepuasan").textContent = avgKepuasan;

    renderCharts(kondisi,kepuasan);
    renderKenyamananChart(data,colKenyamanan,colInsiden);
}

// Upload CSV
csvFile.addEventListener("change", function(e){
    const file = e.target.files[0];
    Papa.parse(file,{
        header:true,
        skipEmptyLines:true,
        complete:function(results){
            updateDashboard(results.data);
        }
    });
});

// Reset
function resetData(){
    if(confirm("Hapus semua data survey?")){
        localStorage.removeItem("surveyData");
        location.reload();
    }
}

// Load data lama
if(surveyData.length>0){
    updateDashboard(surveyData);
}
</script>

</body>
</html>
